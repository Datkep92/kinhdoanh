<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêƒÉng nh·∫≠p h·ªá th·ªëng</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="login-card">
            <div class="login-header">
                <button class="back-btn" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h1 id="loginTitle">ƒêƒÉng nh·∫≠p</h1>
            </div>
            <!-- Th√™m n√∫t "ƒêƒÉng k√Ω HKD" v√†o login form -->
<div class="register-link text-center mt-4" id="registerLink">
    <p>Ch∆∞a c√≥ t√†i kho·∫£n HKD? 
        <a href="#" onclick="showRegisterForm()" class="register-link-btn">
            <i class="fas fa-user-plus"></i> ƒêƒÉng k√Ω ngay
        </a>
    </p>
</div>
            <div class="login-type-selector">
                <button class="type-btn active" onclick="switchLoginType('admin')">
                    <i class="fas fa-user-shield"></i> Admin
                </button>
                <button class="type-btn" onclick="switchLoginType('hkd')">
                    <i class="fas fa-user-tie"></i> HKD
                </button>
            </div>
            
            <form id="loginForm" class="login-form">
                <div class="form-group" id="phoneGroup">
                    <label for="phone">S·ªë ƒëi·ªán tho·∫°i:</label>
                    <div class="input-with-icon">
                        <i class="fas fa-phone"></i>
                        <input type="tel" id="phone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" required>
                    </div>
                </div>
                
                <div class="form-group" id="hkdNameGroup" style="display: none;">
                    
                </div>
                
                <div class="form-group">
                    <label for="password">M·∫≠t kh·∫©u:</label>
                    <div class="input-with-icon">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" required>
                        <button type="button" class="toggle-password" onclick="togglePassword()">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-sign-in-alt"></i> ƒêƒÉng nh·∫≠p
                    </button>
                </div>
            </form>
            
            <div class="login-info">
                <p><strong>Th√¥ng tin ƒëƒÉng nh·∫≠p m·∫∑c ƒë·ªãnh:</strong></p>
                <div id="defaultAdminInfo">
                    <p>Admin: <code>admin / 123123</code></p>
                </div>
                <div id="defaultHKDInfo" style="display: none;">
                    <p>HKD: S·ª≠ d·ª•ng SƒêT v√† m·∫≠t kh·∫©u do Admin c·∫•p</p>
                </div>
            </div>
            
            <div class="login-footer">
                <p>Phi√™n b·∫£n 1.0 - H·ªá th·ªëng b√°n h√†ng Firebase</p>
            </div>
        </div>
    </div>
<!-- Trong login.html, th√™m v√†o sau login-form -->
<div class="register-section" id="registerSection" style="display: none;">
    <hr>
    <h5 class="text-center mb-3">ƒêƒÉng k√Ω HKD m·ªõi</h5>
    
    <form id="registerForm" class="register-form">
        <div class="form-group">
            <label for="registerName">T√™n HKD *</label>
            <div class="input-with-icon">
                <i class="fas fa-store"></i>
                <input type="text" id="registerName" placeholder="Nh·∫≠p t√™n c·ª≠a h√†ng" required>
            </div>
        </div>
        
        <div class="form-group">
            <label for="registerPhone">S·ªë ƒëi·ªán tho·∫°i *</label>
            <div class="input-with-icon">
                <i class="fas fa-phone"></i>
                <input type="tel" id="registerPhone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" required>
            </div>
        </div>
        
        <div class="form-group">
            <label for="registerAddress">ƒê·ªãa ch·ªâ</label>
            <div class="input-with-icon">
                <i class="fas fa-map-marker-alt"></i>
                <input type="text" id="registerAddress" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ (tu·ª≥ ch·ªçn)">
            </div>
        </div>
        
        <div class="form-group">
            <label for="registerPassword">M·∫≠t kh·∫©u *</label>
            <div class="input-with-icon">
                <i class="fas fa-lock"></i>
                <input type="password" id="registerPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u (6+ k√Ω t·ª±)" required>
                <button type="button" class="toggle-password" onclick="toggleRegisterPassword()">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
        </div>
        
        <div class="form-group">
            <label for="registerConfirmPassword">X√°c nh·∫≠n m·∫≠t kh·∫©u *</label>
            <div class="input-with-icon">
                <i class="fas fa-lock"></i>
                <input type="password" id="registerConfirmPassword" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u" required>
            </div>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn-success">
                <i class="fas fa-user-plus"></i> ƒêƒÉng k√Ω ngay
            </button>
            <button type="button" class="btn-secondary" onclick="showLoginForm()">
                <i class="fas fa-sign-in-alt"></i> Quay l·∫°i ƒëƒÉng nh·∫≠p
            </button>
        </div>
    </form>
    
    <div class="register-info mt-3">
        <p class="small text-muted">
            <i class="fas fa-info-circle"></i> 
            Sau khi ƒëƒÉng k√Ω, b·∫°n c√≥ th·ªÉ ƒëƒÉng nh·∫≠p ngay b·∫±ng SƒêT v√† m·∫≠t kh·∫©u ƒë√£ ƒëƒÉng k√Ω.
        </p>
    </div>
</div>


    <!-- Th√™m ph·∫ßn scripts ·ªü cu·ªëi body -->
<!-- Th√™m ph·∫ßn scripts ·ªü cu·ªëi body -->
<script src="js/firebase-config.js"></script>
<script src="js/indexedDB.js"></script>
<script src="js/sync-manager.js"></script>
<script src="js/auth.js"></script>
<script src="js/utils.js"></script>
<script src="js/init.js"></script>
<script src="js/init.js"></script>

    <script>
        // X√°c ƒë·ªãnh lo·∫°i ƒëƒÉng nh·∫≠p t·ª´ URL
        const urlParams = new URLSearchParams(window.location.search);
        let loginType = urlParams.get('type') || 'admin';
        
        function initLoginPage() {
            switchLoginType(loginType);
            
            // X·ª≠ l√Ω form ƒëƒÉng nh·∫≠p
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleLogin();
            });
        }
        
        function switchLoginType(type) {
            loginType = type;
            
            // C·∫≠p nh·∫≠t UI
            document.querySelectorAll('.type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.querySelector(`.type-btn:nth-child(${type === 'admin' ? 1 : 2})`).classList.add('active');
            
            // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ
            document.getElementById('loginTitle').textContent = 
                type === 'admin' ? 'ƒêƒÉng nh·∫≠p Admin' : 'ƒêƒÉng nh·∫≠p HKD';
            
            // Hi·ªÉn th·ªã/·∫©n tr∆∞·ªùng HKD
            document.getElementById('phoneGroup').style.display = 'block';
            document.getElementById('hkdNameGroup').style.display = type === 'hkd' ? 'block' : 'none';
            
            // C·∫≠p nh·∫≠t th√¥ng tin m·∫∑c ƒë·ªãnh
            document.getElementById('defaultAdminInfo').style.display = 
                type === 'admin' ? 'block' : 'none';
            document.getElementById('defaultHKDInfo').style.display = 
                type === 'hkd' ? 'block' : 'none';
        }
        
        function goBack() {
            window.location.href = 'index.html';
        }
        
        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const toggleBtn = document.querySelector('.toggle-password i');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleBtn.className = 'fas fa-eye-slash';
            } else {
                passwordInput.type = 'password';
                toggleBtn.className = 'fas fa-eye';
            }
        }
        
        async function handleLogin() {
            const phone = document.getElementById('phone').value;
            const password = document.getElementById('password').value;
            //const hkdName = loginType === 'hkd' ? document.getElementById('hkdName').value : '';
            
            try {
                if (loginType === 'admin') {
                    // ƒêƒÉng nh·∫≠p admin
                    const success = await authenticateAdmin(phone, password);
                    if (success) {
                        localStorage.setItem('lastLogin', 'admin');
                        window.location.href = 'admin.html';
                    }
                } else {
                    // ƒêƒÉng nh·∫≠p HKD
                    const success = await authenticateHKD(phone, password);
                    if (success) {
                        localStorage.setItem('lastLogin', 'hkd');
                        window.location.href = 'hkd.html';
                    }
                }
            } catch (error) {
                showError(error.message);
            }
        }
        
        function showError(message) {
            // T·∫°o th√¥ng b√°o l·ªói
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `
                <i class="fas fa-exclamation-circle"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            // Th√™m v√†o form
            const form = document.getElementById('loginForm');
            const existingError = form.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }
            form.prepend(errorDiv);
        }
// Switch gi·ªØa login v√† register
function showRegisterForm() {
    console.log('üìù Hi·ªÉn th·ªã form ƒëƒÉng k√Ω');
    
    // ·∫®n form ƒëƒÉng nh·∫≠p
    document.getElementById('loginForm').classList.add('hidden');
    document.getElementById('registerLink').style.display = 'none';
    document.getElementById('defaultAdminInfo').style.display = 'none';
    document.getElementById('defaultHKDInfo').style.display = 'none';
    
    // Hi·ªÉn th·ªã form ƒëƒÉng k√Ω
    document.getElementById('registerSection').style.display = 'block';
    setTimeout(() => {
        document.getElementById('registerSection').classList.remove('hidden');
    }, 10);
    
    // Auto switch to HKD type
    switchLoginType('hkd');
}

function showLoginForm() {
    console.log('üîê Hi·ªÉn th·ªã form ƒëƒÉng nh·∫≠p');
    
    // ·∫®n form ƒëƒÉng k√Ω
    document.getElementById('registerSection').classList.add('hidden');
    setTimeout(() => {
        document.getElementById('registerSection').style.display = 'none';
    }, 300);
    
    // Hi·ªÉn th·ªã form ƒëƒÉng nh·∫≠p
    document.getElementById('loginForm').classList.remove('hidden');
    document.getElementById('registerLink').style.display = 'block';
    document.getElementById('defaultAdminInfo').style.display = 'block';
    
    // Reset form ƒëƒÉng k√Ω
    document.getElementById('registerForm').reset();
}

// Toggle password cho register
function toggleRegisterPassword() {
    const passwordInput = document.getElementById('registerPassword');
    const toggleBtn = document.querySelector('.toggle-password i');
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleBtn.classList.remove('fa-eye');
        toggleBtn.classList.add('fa-eye-slash');
    } else {
        passwordInput.type = 'password';
        toggleBtn.classList.remove('fa-eye-slash');
        toggleBtn.classList.add('fa-eye');
    }
}

// X·ª≠ l√Ω ƒëƒÉng k√Ω HKD
async function handleRegister(event) {
    event.preventDefault();
    
    // L·∫•y d·ªØ li·ªáu t·ª´ form
    const name = document.getElementById('registerName').value.trim();
    const phone = document.getElementById('registerPhone').value.trim();
    const address = document.getElementById('registerAddress').value.trim();
    const password = document.getElementById('registerPassword').value;
    const confirmPassword = document.getElementById('registerConfirmPassword').value;
    
    console.log('üìù ƒêƒÉng k√Ω HKD v·ªõi:', { name, phone, address, passwordLength: password.length });
    
    // Validation
    if (!name || !phone || !password) {
        showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc', 'error');
        return;
    }
    
    if (password.length < 6) {
        showToast('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±', 'error');
        return;
    }
    
    if (password !== confirmPassword) {
        showToast('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp', 'error');
        return;
    }
    
    if (!Utils.validatePhone(phone)) {
        showToast('S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá', 'error');
        return;
    }
    
    try {
        // Hi·ªÉn th·ªã loading
        showLoading('ƒêang ƒëƒÉng k√Ω t√†i kho·∫£n...');
        
        // Kh·ªüi t·∫°o Firebase
        await initFirebase();
        
        // Ki·ªÉm tra s·ªë ƒëi·ªán tho·∫°i ƒë√£ t·ªìn t·∫°i ch∆∞a
        const isDuplicate = await checkDuplicatePhone(phone);
        if (isDuplicate) {
            throw new Error('S·ªë ƒëi·ªán tho·∫°i ƒë√£ ƒë∆∞·ª£c ƒëƒÉng k√Ω');
        }
        
        // T·∫°o ID cho HKD
        const hkdId = Utils.generateId();
        
        // D·ªØ li·ªáu HKD
        const hkdData = {
            id: hkdId,
            name: name,
            phone: phone,
            address: address,
            password: password,
            role: 'hkd',
            createdAt: new Date().toISOString(),
            lastUpdated: new Date().toISOString(),
            _synced: true,
            _autoRegistered: true // ƒê√°nh d·∫•u ƒëƒÉng k√Ω t·ª± ƒë·ªông
        };
        
        // 1. L∆∞u l√™n Firebase v·ªõi c·∫•u tr√∫c chu·∫©n
        const firebaseData = {
            info: {
                name: name,
                phone: phone,
                address: address,
                password: password, // QUAN TR·ªåNG: l∆∞u m·∫≠t kh·∫©u
                role: 'hkd',
                createdAt: hkdData.createdAt,
                lastUpdated: hkdData.lastUpdated,
                _syncedAt: new Date().toISOString(),
                _autoRegistered: true
            },
            categories: {}, // Danh m·ª•c r·ªóng ban ƒë·∫ßu
            invoices: {}    // H√≥a ƒë∆°n r·ªóng ban ƒë·∫ßu
        };
        
        const hkdRef = firebase.database().ref(`hkds/${hkdId}`);
        await hkdRef.set(firebaseData);
        
        console.log('‚úÖ ƒê√£ t·∫°o HKD tr√™n Firebase:', hkdId);
        
        // 2. L∆∞u v√†o IndexedDB local (ƒë·ªÉ c√≥ th·ªÉ login offline sau n√†y)
        try {
            // Kh·ªüi t·∫°o IndexedDB
            await initIndexedDB();
            
            // L∆∞u HKD v√†o IndexedDB
            await updateInStore(STORES.HKDS, hkdData);
            
            console.log('‚úÖ ƒê√£ l∆∞u HKD v√†o IndexedDB local');
        } catch (dbError) {
            console.warn('‚ö†Ô∏è Kh√¥ng th·ªÉ l∆∞u v√†o IndexedDB:', dbError);
            // Kh√¥ng block n·∫øu l·ªói IndexedDB
        }
        
        // 3. ƒêƒÉng nh·∫≠p t·ª± ƒë·ªông
        console.log('üîë T·ª± ƒë·ªông ƒëƒÉng nh·∫≠p sau khi ƒëƒÉng k√Ω...');
        
        currentUser = {
            id: hkdId,
            phone: phone,
            name: name,
            address: address,
            role: 'hkd',
            loginTime: new Date().toISOString()
        };
        
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        
        // 4. Chuy·ªÉn ƒë·∫øn trang HKD
        showToast('ƒêƒÉng k√Ω th√†nh c√¥ng! ƒêang chuy·ªÉn ƒë·∫øn trang HKD...', 'success');
        
        setTimeout(() => {
            window.location.href = 'hkd.html';
        }, 1500);
        
    } catch (error) {
        console.error('‚ùå L·ªói ƒëƒÉng k√Ω:', error);
        showToast(`L·ªói ƒëƒÉng k√Ω: ${error.message}`, 'error');
    } finally {
        hideLoading();
    }
}

// Ki·ªÉm tra s·ªë ƒëi·ªán tho·∫°i tr√πng
async function checkDuplicatePhone(phone) {
    try {
        await initFirebase();
        
        // L·∫•y t·∫•t c·∫£ HKD t·ª´ Firebase
        const hkdsRef = firebase.database().ref('hkds');
        const snapshot = await hkdsRef.once('value');
        const hkdsData = snapshot.val();
        
        if (!hkdsData) return false;
        
        // Duy·ªát qua t·∫•t c·∫£ HKD
        for (const [hkdId, hkdData] of Object.entries(hkdsData)) {
            if (hkdData.info && hkdData.info.phone === phone) {
                return true; // ƒê√£ t·ªìn t·∫°i
            }
        }
        
        return false; // Ch∆∞a t·ªìn t·∫°i
        
    } catch (error) {
        console.error('‚ùå L·ªói ki·ªÉm tra tr√πng s·ªë ƒëi·ªán tho·∫°i:', error);
        throw error;
    }
}

// Helper functions (th√™m v√†o n·∫øu ch∆∞a c√≥)
function showToast(message, type = 'info') {
    // T·∫°o toast element ƒë∆°n gi·∫£n
    const toast = document.createElement('div');
    toast.className = `toast-notification toast-${type}`;
    toast.innerHTML = `
        <div class="toast-content">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Hi·ªáu ·ª©ng
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function showLoading(message) {
    let loading = document.getElementById('loadingOverlay');
    if (!loading) {
        loading = document.createElement('div');
        loading.id = 'loadingOverlay';
        loading.innerHTML = `
            <div class="loading-spinner">
                <div class="spinner"></div>
                <div class="loading-text">${message}</div>
            </div>
        `;
        document.body.appendChild(loading);
    } else {
        loading.querySelector('.loading-text').textContent = message;
    }
    loading.classList.add('show');
}

function hideLoading() {
    const loading = document.getElementById('loadingOverlay');
    if (loading) {
        loading.classList.remove('show');
        setTimeout(() => loading.remove(), 300);
    }
}

// Switch gi·ªØa login v√† register
function showRegisterForm() {
    console.log('üìù Hi·ªÉn th·ªã form ƒëƒÉng k√Ω');
    
    // ·∫®n form ƒëƒÉng nh·∫≠p
    document.getElementById('loginForm').classList.add('hidden');
    document.getElementById('registerLink').style.display = 'none';
    document.getElementById('defaultAdminInfo').style.display = 'none';
    document.getElementById('defaultHKDInfo').style.display = 'none';
    
    // Hi·ªÉn th·ªã form ƒëƒÉng k√Ω
    document.getElementById('registerSection').style.display = 'block';
    setTimeout(() => {
        document.getElementById('registerSection').classList.remove('hidden');
    }, 10);
    
    // Auto switch to HKD type
    switchLoginType('hkd');
}

function showLoginForm() {
    console.log('üîê Hi·ªÉn th·ªã form ƒëƒÉng nh·∫≠p');
    
    // ·∫®n form ƒëƒÉng k√Ω
    document.getElementById('registerSection').classList.add('hidden');
    setTimeout(() => {
        document.getElementById('registerSection').style.display = 'none';
    }, 300);
    
    // Hi·ªÉn th·ªã form ƒëƒÉng nh·∫≠p
    document.getElementById('loginForm').classList.remove('hidden');
    document.getElementById('registerLink').style.display = 'block';
    document.getElementById('defaultAdminInfo').style.display = 'block';
    
    // Reset form ƒëƒÉng k√Ω
    document.getElementById('registerForm').reset();
}

// Toggle password cho register
function toggleRegisterPassword() {
    const passwordInput = document.getElementById('registerPassword');
    const toggleBtn = document.querySelector('.toggle-password i');
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleBtn.classList.remove('fa-eye');
        toggleBtn.classList.add('fa-eye-slash');
    } else {
        passwordInput.type = 'password';
        toggleBtn.classList.remove('fa-eye-slash');
        toggleBtn.classList.add('fa-eye');
    }
}

async function handleRegister(event) {
    event.preventDefault();
    
    // 1. L·∫•y d·ªØ li·ªáu t·ª´ form
    const name = document.getElementById('registerName').value.trim();
    const phone = document.getElementById('registerPhone').value.trim();
    const address = document.getElementById('registerAddress').value.trim();
    const password = document.getElementById('registerPassword').value;
    const confirmPassword = document.getElementById('registerConfirmPassword').value;
    
    console.log('üìù B·∫Øt ƒë·∫ßu ƒëƒÉng k√Ω HKD m·ªõi:', { name, phone });
    
    // 2. Validation c∆° b·∫£n
    if (!name || !phone || !password) {
        showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc', 'error');
        return;
    }
    
    if (password.length < 6) {
        showToast('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±', 'error');
        return;
    }
    
    if (password !== confirmPassword) {
        showToast('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp', 'error');
        return;
    }
    
    if (typeof Utils !== 'undefined' && !Utils.validatePhone(phone)) {
        showToast('S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá', 'error');
        return;
    }
    
    try {
        showLoading('ƒêang x·ª≠ l√Ω ƒëƒÉng k√Ω...');
        
        // 3. Kh·ªüi t·∫°o Firebase v√† DB
        await initFirebase();
        await initIndexedDB();
        
        // 4. Ki·ªÉm tra tr√πng l·∫∑p tr√™n Firebase
        const isDuplicate = await checkDuplicatePhone(phone);
        if (isDuplicate) {
            throw new Error('S·ªë ƒëi·ªán tho·∫°i n√†y ƒë√£ ƒë∆∞·ª£c ƒëƒÉng k√Ω t√†i kho·∫£n');
        }

        // =========================================================
        // B∆Ø·ªöC QUAN TR·ªåNG: D·ªåN D·∫∏P D·ªÆ LI·ªÜU C≈® TR∆Ø·ªöC KHI T·∫†O M·ªöI
        // Tr√°nh l·ªói Admin import kh√¥ng hi·ªÉn th·ªã h√†ng h√≥a do tr√πng DB local
        // =========================================================
        console.log('üßπ ƒêang d·ªçn d·∫πp d·ªØ li·ªáu local c≈©...');
        const db = await getDB();
        const storesToClear = [STORES.PRODUCTS, STORES.CATEGORIES, STORES.INVOICES, STORES.SYNC_QUEUE];
        
        for (const storeName of storesToClear) {
            const transaction = db.transaction(storeName, 'readwrite');
            const store = transaction.objectStore(storeName);
            await new Promise((resolve) => {
                const req = store.clear();
                req.onsuccess = () => resolve();
                req.onerror = () => resolve(); // V·∫´n ti·∫øp t·ª•c n·∫øu l·ªói
            });
        }
        
        // 5. Kh·ªüi t·∫°o ID v√† c·∫•u tr√∫c d·ªØ li·ªáu
        const hkdId = phone; // S·ª≠ d·ª•ng phone l√†m ID ƒë·ªÉ d·ªÖ qu·∫£n l√Ω ho·∫∑c d√πng Utils.generateId()
        const timestamp = new Date().toISOString();
        
        const hkdDataForLocal = {
            id: hkdId,
            name: name,
            phone: phone,
            address: address,
            password: password,
            role: 'hkd',
            createdAt: timestamp,
            lastUpdated: timestamp,
            _synced: true
        };
        
        const firebaseData = {
            info: {
                id: hkdId,
                name: name,
                phone: phone,
                address: address,
                password: password,
                role: 'hkd',
                createdAt: timestamp,
                lastUpdated: timestamp,
                _autoRegistered: true
            },
            categories: {}, 
            products: {},
            invoices: {}
        };
        
        // 6. L∆∞u l√™n Firebase
        await firebase.database().ref(`hkds/${hkdId}`).set(firebaseData);
        console.log('‚úÖ ƒê√£ l∆∞u th√¥ng tin l√™n Firebase');
        
        // 7. L∆∞u v√†o IndexedDB local
        await updateInStore(STORES.HKDS, hkdDataForLocal);
        console.log('‚úÖ ƒê√£ kh·ªüi t·∫°o IndexedDB s·∫°ch cho HKD m·ªõi');
        
        // 8. Thi·∫øt l·∫≠p tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
        currentUser = {
            id: hkdId,
            phone: phone,
            name: name,
            role: 'hkd',
            loginTime: timestamp
        };
        
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        
        // 9. Th√¥ng b√°o v√† chuy·ªÉn h∆∞·ªõng
        showToast('ƒêƒÉng k√Ω th√†nh c√¥ng! ƒêang kh·ªüi t·∫°o kh√¥ng gian l√†m vi·ªác...', 'success');
        
        // Ch·∫°y n·ªÅn vi·ªác t·∫£i d·ªØ li·ªáu m·∫´u n·∫øu c·∫ßn ·ªü ƒë√¢y
        
        setTimeout(() => {
            window.location.href = 'hkd.html';
        }, 1500);
        
    } catch (error) {
        console.error('‚ùå L·ªói ƒëƒÉng k√Ω:', error);
        showToast(error.message, 'error');
    } finally {
        hideLoading();
    }
}
// Ki·ªÉm tra s·ªë ƒëi·ªán tho·∫°i tr√πng
async function checkDuplicatePhone(phone) {
    try {
        await initFirebase();
        
        // L·∫•y t·∫•t c·∫£ HKD t·ª´ Firebase
        const hkdsRef = firebase.database().ref('hkds');
        const snapshot = await hkdsRef.once('value');
        const hkdsData = snapshot.val();
        
        if (!hkdsData) return false;
        
        // Duy·ªát qua t·∫•t c·∫£ HKD
        for (const [hkdId, hkdData] of Object.entries(hkdsData)) {
            if (hkdData.info && hkdData.info.phone === phone) {
                return true; // ƒê√£ t·ªìn t·∫°i
            }
        }
        
        return false; // Ch∆∞a t·ªìn t·∫°i
        
    } catch (error) {
        console.error('‚ùå L·ªói ki·ªÉm tra tr√πng s·ªë ƒëi·ªán tho·∫°i:', error);
        throw error;
    }
}

// Helper functions (th√™m v√†o n·∫øu ch∆∞a c√≥)
function showToast(message, type = 'info') {
    // T·∫°o toast element ƒë∆°n gi·∫£n
    const toast = document.createElement('div');
    toast.className = `toast-notification toast-${type}`;
    toast.innerHTML = `
        <div class="toast-content">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Hi·ªáu ·ª©ng
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function showLoading(message) {
    let loading = document.getElementById('loadingOverlay');
    if (!loading) {
        loading = document.createElement('div');
        loading.id = 'loadingOverlay';
        loading.innerHTML = `
            <div class="loading-spinner">
                <div class="spinner"></div>
                <div class="loading-text">${message}</div>
            </div>
        `;
        document.body.appendChild(loading);
    } else {
        loading.querySelector('.loading-text').textContent = message;
    }
    loading.classList.add('show');
}

/*************  ‚ú® Windsurf Command ‚≠ê  *************/
/**
 * Hide loading overlay
 * 
 * @param {HTMLElement} loading - Loading overlay element
 */
/*******  fe15a1b5-660a-4f90-891f-ddfbf77946a6  *******/
function hideLoading() {
    const loading = document.getElementById('loadingOverlay');
    if (loading) {
        loading.classList.remove('show');
        setTimeout(() => loading.remove(), 300);
    }
}

// Th√™m event listener khi page load
document.addEventListener('DOMContentLoaded', function() {
    // Login form
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
        loginForm.addEventListener('submit', handleLogin);
    }
    
    // Register form
    const registerForm = document.getElementById('registerForm');
    if (registerForm) {
        registerForm.addEventListener('submit', handleRegister);
    }
    
    // Auto focus khi switch to register
    window.showRegisterForm = showRegisterForm;
    window.showLoginForm = showLoginForm;
    window.toggleRegisterPassword = toggleRegisterPassword;
});
        // Kh·ªüi t·∫°o trang
        window.onload = initLoginPage;
    </script>
</body>
</html>